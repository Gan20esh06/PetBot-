<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Robot Remote Control</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        color: white;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 14px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ff4444;
        animation: pulse 2s infinite;
      }

      .status-dot.connected {
        background: #44ff44;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .camera-feed {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
        color: white;
      }

      .camera-feed h2 {
        margin-bottom: 15px;
        font-size: 20px;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        max-width: 640px;
        margin: 0 auto;
      }

      #remoteVideo {
        width: 100%;
        display: block;
      }

      .detection-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .objects-list {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        color: white;
        flex: 1;
      }

      .objects-list h2 {
        margin-bottom: 15px;
        font-size: 20px;
      }

      .object-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .object-item:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(5px);
      }

      .object-item.locked {
        background: #ff6b6b;
        font-weight: bold;
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
      }

      .lock-icon {
        font-size: 20px;
      }

      .info-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: 15px;
        margin-top: 20px;
        color: white;
        font-size: 14px;
      }

      .info-panel p {
        margin-bottom: 5px;
      }

      .empty-state {
        text-align: center;
        opacity: 0.7;
        padding: 40px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ü§ñ Pet Robot Remote Control</h1>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </div>

    <div class="camera-feed">
      <h2>üìπ Robot Camera View</h2>
      <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        <canvas class="detection-overlay" id="detectionCanvas"></canvas>
      </div>
    </div>

    <div class="objects-list">
      <h2>üîç Detected Objects (Tap to Lock/Unlock)</h2>
      <div id="objectsList">
        <div class="empty-state">
          <p>No objects detected yet...</p>
          <p>Enable object detection on the robot</p>
        </div>
      </div>
    </div>

    <div class="info-panel">
      <p><strong>üì± Instructions:</strong></p>
      <p>‚Ä¢ Tap any detected object to lock tracking</p>
      <p>‚Ä¢ Robot will automatically follow the locked object</p>
      <p>‚Ä¢ Tap again to unlock and stop tracking</p>
      <p>‚Ä¢ Make sure robot's object detection is ON</p>
    </div>

    <script>
      let websocket = null;
      let detectedObjects = [];
      let lockedObject = null;

      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const objectsList = document.getElementById("objectsList");

      // Connect to WebSocket server
      function connectWebSocket() {
        const wsUrl = "ws://" + window.location.hostname + ":8080";
        statusText.textContent = "Connecting to robot...";

        try {
          websocket = new WebSocket(wsUrl);

          websocket.onopen = () => {
            statusDot.classList.add("connected");
            statusText.textContent = "Connected to robot";
            console.log("‚úÖ Connected to robot");
          };

          websocket.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              if (data.type === "objects") {
                // Update detected objects list
                detectedObjects = data.objects;
                updateObjectsList();
              } else if (data.type === "lock") {
                // Another client locked an object
                lockedObject = data.object;
                updateObjectsList();
              } else if (data.type === "unlock") {
                // Another client unlocked
                lockedObject = null;
                updateObjectsList();
              }
            } catch (error) {
              console.error("Message error:", error);
            }
          };

          websocket.onerror = (error) => {
            console.error("WebSocket error:", error);
            statusText.textContent = "Connection error";
          };

          websocket.onclose = () => {
            statusDot.classList.remove("connected");
            statusText.textContent = "Disconnected - Reconnecting...";
            console.log("Disconnected - Reconnecting...");
            setTimeout(connectWebSocket, 3000);
          };
        } catch (error) {
          console.error("Connection error:", error);
          statusText.textContent = "Failed to connect";
          setTimeout(connectWebSocket, 3000);
        }
      }

      function updateObjectsList() {
        if (detectedObjects.length === 0) {
          objectsList.innerHTML = `
                    <div class="empty-state">
                        <p>No objects detected yet...</p>
                        <p>Enable object detection on the robot</p>
                    </div>
                `;
          return;
        }

        objectsList.innerHTML = "";
        detectedObjects.forEach((obj) => {
          const item = document.createElement("div");
          item.className = "object-item";

          const isLocked = lockedObject && obj.class === lockedObject.class;
          if (isLocked) {
            item.classList.add("locked");
          }

          item.innerHTML = `
                    <span>${obj.class} (${(obj.confidence * 100).toFixed(
            0
          )}%)</span>
                    <span class="lock-icon">${isLocked ? "üîí" : "üîì"}</span>
                `;

          item.onclick = () => lockObject(obj);
          objectsList.appendChild(item);
        });
      }

      function lockObject(obj) {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
          if (lockedObject && lockedObject.class === obj.class) {
            // Unlock
            websocket.send(
              JSON.stringify({
                type: "unlock",
              })
            );
            lockedObject = null;
          } else {
            // Lock
            websocket.send(
              JSON.stringify({
                type: "lock",
                object: obj,
              })
            );
            lockedObject = obj;
          }
          updateObjectsList();
        }
      }

      // Simulate detected objects for testing (remove when robot sends real data)
      function simulateObjects() {
        if (detectedObjects.length === 0) {
          detectedObjects = [
            { class: "person", confidence: 0.89 },
            { class: "cup", confidence: 0.76 },
            { class: "cell phone", confidence: 0.92 },
          ];
          updateObjectsList();
        }
      }

      // Start connection
      connectWebSocket();

      // Test mode - comment out when using real robot
      setTimeout(simulateObjects, 3000);
    </script>
  </body>
</html>
